# –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ await –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –≤ webhook

## üîç –î–µ—Ç–∞–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã

### –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

1. **–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ `await` –ø—Ä–∏ –≤—ã–∑–æ–≤–µ `handleCommand`**
   - –í `server.js` —Å—Ç—Ä–æ–∫–∞ 1621: `telegramDomainBot.handleCommand(chat.id, command, args);`
   - –ú–µ—Ç–æ–¥ `handleCommand` —è–≤–ª—è–µ—Ç—Å—è `async`, –Ω–æ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –±–µ–∑ `await`
   - –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ:
     - –û—à–∏–±–∫–∏ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è (Promise –æ—Ç–∫–ª–æ–Ω—è–µ—Ç—Å—è, –Ω–æ –Ω–∏–∫—Ç–æ –Ω–µ –∂–¥–µ—Ç)
     - –õ–æ–≥–∏ –∏–∑ `handleCommand` –º–æ–≥—É—Ç –Ω–µ –ø–æ—è–≤–ª—è—Ç—å—Å—è, –µ—Å–ª–∏ –æ—à–∏–±–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –¥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
     - Webhook –æ—Ç–≤–µ—á–∞–µ—Ç 200 OK –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–º–∞–Ω–¥—ã

2. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –≤ webhook**
   - –ù–µ—Ç `try-catch` –±–ª–æ–∫–∞ –≤–æ–∫—Ä—É–≥ –≤—ã–∑–æ–≤–∞ `handleCommand`
   - –û—à–∏–±–∫–∏ —Ç–µ—Ä—è—é—Ç—Å—è –∏ –Ω–µ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è
   - –≠—Ç–æ –æ–±—ä—è—Å–Ω—è–µ—Ç, –ø–æ—á–µ–º—É –≤ –ª–æ–≥–∞—Ö –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π –∏–∑ `handleCommand` –∏ `showMainMenu`

3. **–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON: `SyntaxError: Unexpected token '<', "<html>`**
   - Telegram API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç HTML –≤–º–µ—Å—Ç–æ JSON
   - –≠—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ `telegram-domain-bot.js:49:33` (—Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è –∫–æ–¥–∞)
   - –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:
     - –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω –±–æ—Ç–∞
     - –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL API
     - –ü—Ä–æ–±–ª–µ–º–∞ —Å –ø—Ä–æ–∫—Å–∏ (SOCKS5 –º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã –∫ api.telegram.org)
     - Rate limiting –æ—Ç Telegram

### –ê–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤:

```
[Telegram Webhook] Handling command: /menu with args:
```

**–ù–û –ù–ï–¢ –õ–û–ì–û–í:**
- `[TelegramDomainBot] handleCommand: /menu for chat ...` - –ù–ï–¢
- `[TelegramDomainBot] Calling showMainMenu for chat ...` - –ù–ï–¢
- `[TelegramDomainBot] showMainMenu called for chat ...` - –ù–ï–¢
- `[TelegramDomainBot] Sending message with keyboard: ...` - –ù–ï–¢

**–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç:**
- `handleCommand` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è, –Ω–æ –æ—à–∏–±–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –¥–æ –ø–µ—Ä–≤–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
- –ò–ª–∏ –æ—à–∏–±–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç, –Ω–æ –Ω–µ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –∏–∑-–∑–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è `await`

### –ü–æ—á–µ–º—É –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ñ–∏–∫—Å—ã –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∏:

1. **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤ `sendMessage`**
   - –ù–µ –ø–æ–º–æ–≥–ª–æ, –ø–æ—Ç–æ–º—É —á—Ç–æ `sendMessage` –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
   - –û—à–∏–±–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ä–∞–Ω—å—à–µ, –≤ `handleCommand` –∏–ª–∏ `showMainMenu`
   - –ë–µ–∑ `await` –æ—à–∏–±–∫–∞ —Ç–µ—Ä—è–µ—Ç—Å—è

2. **–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∞ `reply_markup`**
   - –§–æ—Ä–º–∞—Ç –±—ã–ª –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Å —Å–∞–º–æ–≥–æ –Ω–∞—á–∞–ª–∞
   - –ü—Ä–æ–±–ª–µ–º–∞ –Ω–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ, –∞ –≤ —Ç–æ–º, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–æ–æ–±—â–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è

3. **–£–ª—É—á—à–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–≤–µ—Ç–∞ –æ—Ç Telegram API**
   - –ü–æ–º–æ–≥–ª–æ –±—ã, –µ—Å–ª–∏ –±—ã –∑–∞–ø—Ä–æ—Å –¥–æ—Ö–æ–¥–∏–ª –¥–æ Telegram API
   - –ù–æ –∑–∞–ø—Ä–æ—Å –Ω–µ –¥–æ—Ö–æ–¥–∏—Ç, –ø–æ—Ç–æ–º—É —á—Ç–æ –æ—à–∏–±–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ä–∞–Ω—å—à–µ

## üõ†Ô∏è –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

### 1. –î–æ–±–∞–≤–ª–µ–Ω `await` –ø—Ä–∏ –≤—ã–∑–æ–≤–µ `handleCommand`

**–§–∞–π–ª:** `server.js`

**–ë—ã–ª–æ:**
```javascript
telegramDomainBot.handleCommand(chat.id, command, args);
```

**–°—Ç–∞–ª–æ:**
```javascript
try {
  await telegramDomainBot.handleCommand(chat.id, command, args);
  logger.info(`[Telegram Webhook] Command ${command} processed successfully`);
} catch (error) {
  logger.error(`[Telegram Webhook] Error processing command ${command}:`, error);
  logger.error(`[Telegram Webhook] Error stack:`, error.stack);
}
```

**–ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ:**
- –¢–µ–ø–µ—Ä—å –æ—à–∏–±–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è
- –ú–æ–∂–Ω–æ —É–≤–∏–¥–µ—Ç—å —Ä–µ–∞–ª—å–Ω—É—é –ø—Ä–∏—á–∏–Ω—É –ø—Ä–æ–±–ª–µ–º—ã
- Webhook –∂–¥–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–º–∞–Ω–¥—ã

### 2. –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –¥–ª—è callback queries

**–§–∞–π–ª:** `server.js`

**–ë—ã–ª–æ:**
```javascript
telegramDomainBot.handleCallbackQuery(update.callback_query);
```

**–°—Ç–∞–ª–æ:**
```javascript
try {
  await telegramDomainBot.handleCallbackQuery(update.callback_query);
  logger.info(`[Telegram Webhook] Callback query processed successfully`);
} catch (error) {
  logger.error(`[Telegram Webhook] Error processing callback query:`, error);
  logger.error(`[Telegram Webhook] Error stack:`, error.stack);
}
```

### 3. Webhook handler —Å—Ç–∞–ª async

**–§–∞–π–ª:** `server.js`

**–ë—ã–ª–æ:**
```javascript
app.post('/api/telegram/webhook', express.json(), (req, res) => {
```

**–°—Ç–∞–ª–æ:**
```javascript
app.post('/api/telegram/webhook', express.json(), async (req, res) => {
```

**–ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ:**
- –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `await` –≤–Ω—É—Ç—Ä–∏ handler
- –û—à–∏–±–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –Ω–∞ –≤–µ—Ä—Ö–Ω–µ–º —É—Ä–æ–≤–Ω–µ
- –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ async –æ–ø–µ—Ä–∞—Ü–∏–π

## ‚úÖ –ü–æ—á–µ–º—É —ç—Ç–æ —Ä–µ—à–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ —Å—Ä–∞–±–æ—Ç–∞—Ç—å

1. **–û—à–∏–±–∫–∏ —Ç–µ–ø–µ—Ä—å –ª–æ–≥–∏—Ä—É—é—Ç—Å—è**
   - –° `await` –∏ `try-catch` –≤—Å–µ –æ—à–∏–±–∫–∏ –±—É–¥—É—Ç –≤–∏–¥–Ω—ã –≤ –ª–æ–≥–∞—Ö
   - –ú–æ–∂–Ω–æ —É–≤–∏–¥–µ—Ç—å —Ä–µ–∞–ª—å–Ω—É—é –ø—Ä–∏—á–∏–Ω—É –ø—Ä–æ–±–ª–µ–º—ã (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω, –ø—Ä–æ–±–ª–µ–º–∞ —Å –ø—Ä–æ–∫—Å–∏, –∏ —Ç.–¥.)

2. **–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ async –æ–ø–µ—Ä–∞—Ü–∏–π**
   - `handleCommand` –∏ `showMainMenu` —è–≤–ª—è—é—Ç—Å—è async —Ñ—É–Ω–∫—Ü–∏—è–º–∏
   - –ë–µ–∑ `await` –æ–Ω–∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç Promise, –∫–æ—Ç–æ—Ä—ã–π –Ω–∏–∫—Ç–æ –Ω–µ –∂–¥–µ—Ç
   - –° `await` –∫–æ–¥ –∂–¥–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏

3. **–ü–æ–ª–Ω—ã–π stack trace**
   - –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ —É–≤–∏–¥–µ—Ç—å –ø–æ–ª–Ω—ã–π stack trace –æ—à–∏–±–∫–∏
   - –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç —Ç–æ—á–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –≥–¥–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–æ–±–ª–µ–º–∞

## üìä –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è:

### –ï—Å–ª–∏ –≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:
1. `[Telegram Webhook] Handling command: /menu with args:`
2. `[TelegramDomainBot] handleCommand: /menu for chat ...`
3. `[TelegramDomainBot] Calling showMainMenu for chat ...`
4. `[TelegramDomainBot] showMainMenu called for chat ...`
5. `[TelegramDomainBot] Created keyboard: {...}`
6. `[TelegramDomainBot] Sending message with keyboard: {...}`
7. `[TelegramDomainBot] Sending payload to Telegram API: {...}`
8. `[TelegramDomainBot] Response status: 200, headers: {...}`
9. `[TelegramDomainBot] Message sent successfully. Result: {...}`
10. `[Telegram Webhook] Command /menu processed successfully`

### –ï—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∞:
1. `[Telegram Webhook] Handling command: /menu with args:`
2. `[TelegramDomainBot] handleCommand: /menu for chat ...`
3. `[Telegram Webhook] Error processing command /menu: [–û–®–ò–ë–ö–ê]`
4. `[Telegram Webhook] Error stack: [STACK TRACE]`

**–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ —É–≤–∏–¥–µ—Ç—å —Ä–µ–∞–ª—å–Ω—É—é –ø—Ä–∏—á–∏–Ω—É –ø—Ä–æ–±–ª–µ–º—ã!**

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–û–±–Ω–æ–≤–∏—Ç—å –∫–æ–¥ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:**
   ```bash
   cd ~/reverse-proxy
   git pull origin main
   pm2 restart reverse-proxy --update-env
   ```

2. **–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É –±–æ—Ç—É:**
   - –û—Ç–ø—Ä–∞–≤–∏—Ç—å `/start` –∏–ª–∏ `/menu` –≤ Telegram

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏:**
   ```bash
   pm2 logs reverse-proxy --lines 100
   ```

4. **–ê–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤:**
   - –ï—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∞ - —É–≤–∏–¥–µ—Ç—å —Ä–µ–∞–ª—å–Ω—É—é –ø—Ä–∏—á–∏–Ω—É
   - –ï—Å–ª–∏ –≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç - —É–≤–∏–¥–µ—Ç—å –ø–æ–ª–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è

## üîß –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ (–µ—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è)

–ï—Å–ª–∏ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—Å–µ –µ—â–µ –µ—Å—Ç—å –æ—à–∏–±–∫–∞ "HTML instead of JSON":

1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ–∫–µ–Ω –±–æ—Ç–∞:**
   ```bash
   curl "https://api.telegram.org/bot8528667086:AAHrl7LOf7kimNCwfFNOFMPVkWgGTv_KUuM/getMe"
   ```
   –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å JSON —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –±–æ—Ç–µ, –∞ –Ω–µ HTML

2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ–∫—Å–∏:**
   - SOCKS5 –ø—Ä–æ–∫—Å–∏ –º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã –∫ `api.telegram.org`
   - –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å –ø—Ä–æ–∫—Å–∏ –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Telegram API

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å rate limiting:**
   - Telegram –º–æ–∂–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ª–æ–≥–∞—Ö —Å—Ç–∞—Ç—É—Å –∫–æ–¥ –æ—Ç–≤–µ—Ç–∞
