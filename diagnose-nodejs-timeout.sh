#!/bin/bash

echo "=========================================="
echo "  –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ó–ê–í–ò–°–ê–ù–ò–Ø NODE.JS"
echo "=========================================="
echo ""

cd ~/reverse-proxy || cd /root/reverse-proxy || exit 1

# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ .env –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –ø—Ä–æ–∫—Å–∏
echo "1Ô∏è‚É£  –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø—Ä–æ–∫—Å–∏ –≤ .env:"
echo "----------------------------------------"
if grep -q "USE_PROXY=true" .env; then
    echo "‚ö†Ô∏è  –í–Ω–µ—à–Ω–∏–π –ø—Ä–æ–∫—Å–∏ –í–ö–õ–Æ–ß–ï–ù"
    echo "–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–æ–∫—Å–∏:"
    grep -E "PROXY_HOST|PROXY_PORT|PROXY_USERNAME" .env | head -5
    echo ""
    echo "üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å –ø—Ä–æ–∫—Å–∏:"
    echo "   sed -i 's/USE_PROXY=true/USE_PROXY=false/' .env"
    echo "   pm2 restart reverse-proxy --update-env"
else
    echo "‚úÖ –í–Ω–µ—à–Ω–∏–π –ø—Ä–æ–∫—Å–∏ –æ—Ç–∫–ª—é—á–µ–Ω"
fi
echo ""

# 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ PM2 –Ω–∞ –æ—à–∏–±–∫–∏
echo "2Ô∏è‚É£  –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—à–∏–±–∫–∏ –≤ –ª–æ–≥–∞—Ö PM2:"
echo "----------------------------------------"
pm2 logs reverse-proxy --lines 50 --err --nostream | tail -30
echo ""

# 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–π–º–∞—É—Ç–æ–≤ –≤ –∫–æ–Ω—Ñ–∏–≥–µ
echo "3Ô∏è‚É£  –¢–∞–π–º–∞—É—Ç—ã –≤ config.js:"
echo "----------------------------------------"
if [ -f "config.js" ]; then
    grep -E "timeout|PROXY_TIMEOUT" config.js | head -5
else
    echo "config.js –Ω–µ –Ω–∞–π–¥–µ–Ω"
fi
echo ""

# 4. –¢–µ—Å—Ç –ø—Ä—è–º–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –∫ —Ü–µ–ª–µ–≤–æ–º—É —Å–µ—Ä–≤–µ—Ä—É
echo "4Ô∏è‚É£  –¢–µ—Å—Ç –∑–∞–ø—Ä–æ—Å–∞ –∫ eflow.ie (—á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏, –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω):"
echo "----------------------------------------"
echo "–ó–∞–ø—Ä–æ—Å –∫ https://eflow.ie/pay-toll (—Ç–∞–π–º–∞—É—Ç 10 —Å–µ–∫)..."
curl -s -w "\nHTTP:%{http_code}\nTIME:%{time_total}s" --max-time 10 -I https://eflow.ie/pay-toll 2>&1 | head -15
echo ""

# 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏
echo "5Ô∏è‚É£  –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ Node.js:"
echo "----------------------------------------"
pm2 describe reverse-proxy | grep -E "memory|cpu|restarts"
echo ""

# 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
echo "6Ô∏è‚É£  –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –Ω–∞ –ø–æ—Ä—Ç—É 3000:"
echo "----------------------------------------"
if command -v netstat &> /dev/null; then
    netstat -an | grep ":3000" | grep ESTABLISHED | wc -l | xargs echo "–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π:"
elif command -v ss &> /dev/null; then
    ss -an | grep ":3000" | grep ESTAB | wc -l | xargs echo "–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π:"
fi
echo ""

echo "=========================================="
echo "  –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò"
echo "=========================================="
echo ""
echo "–ï—Å–ª–∏ Node.js –∑–∞–≤–∏—Å–∞–µ—Ç –Ω–∞ –∑–∞–ø—Ä–æ—Å–∞—Ö –∫ /pay-toll:"
echo "1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–Ω–µ—à–Ω–∏–π –ø—Ä–æ–∫—Å–∏ (USE_PROXY –≤ .env)"
echo "2. –£–≤–µ–ª–∏—á—å—Ç–µ PROXY_TIMEOUT –≤ .env (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 120000 = 120 —Å–µ–∫)"
echo "3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: pm2 logs reverse-proxy --lines 100"
echo "4. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–∫–ª—é—á–∏—Ç—å –ø—Ä–æ–∫—Å–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ –¥–ª—è —Ç–µ—Å—Ç–∞"
echo ""
